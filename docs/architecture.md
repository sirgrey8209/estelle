# Estelle μ‹μ¤ν… μ•„ν‚¤ν…μ²

## κ°μ”

Estelleμ€ μ—¬λ¬ PCμ™€ λ¨λ°”μΌ κΈ°κΈ°μ—μ„ Claude Codeλ¥Ό μ›κ²©μΌλ΅ μ μ–΄ν•  μ μκ² ν•΄μ£Όλ” μ‹μ¤ν…μ…λ‹λ‹¤.

---

## ν†µμ‹  κµ¬μ΅°

```
                         β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
                         β”‚  Estelle Relay  β”‚
                         β”‚   (Fly.io)      β”‚
                         β”‚   Port 8080     β”‚
                         β””β”€β”€β”€β”€β”€β”€β”€β”€β”¬β”€β”€β”€β”€β”€β”€β”€β”€β”
                                  β”‚ WSS (443)
         β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”Όβ”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
         β”‚                        β”‚                        β”‚
   β”β”€β”€β”€β”€β”€β”΄β”€β”€β”€β”€β”€β”            β”β”€β”€β”€β”€β”€β”΄β”€β”€β”€β”€β”€β”            β”β”€β”€β”€β”€β”€β”΄β”€β”€β”€β”€β”€β”
   β”‚  Pylon    β”‚            β”‚  Pylon    β”‚            β”‚  Desktop  β”‚
   β”‚  (μ§‘ PC)  β”‚            β”‚ (νμ‚¬ PC) β”‚            β”‚  Mobile   β”‚
   β”‚ deviceId:1β”‚            β”‚ deviceId:2β”‚            β”‚ deviceId: β”‚
   β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”            β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”            β”‚ 100+      β”‚
                                                     β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

### ν•µμ‹¬ μ›μΉ™

1. **λ¨λ“  ν΄λΌμ΄μ–ΈνΈλ” Relayμ— μ—°κ²°**
   - Desktop β†’ Relay β†’ Pylon
   - Mobile β†’ Relay β†’ Pylon
   - Pylon β†’ Relay (λ‹¤λ¥Έ ν΄λΌμ΄μ–ΈνΈ/Pylonκ³Ό ν†µμ‹ )

2. **Relayλ” μμ λΌμ°ν„°**
   - λ©”μ‹μ§€ λ‚΄μ©μ„ ν•΄μ„ν•μ§€ μ•μ
   - `to`, `broadcast` ν•„λ“λ§ λ³΄κ³  λΌμ°ν…

3. **Pylonμ΄ Single Source of Truth**
   - μ±„ν… λ©”μ‹μ§€, λ°μ¤ν¬ μƒνƒ λ“± λ¨λ“  λ°μ΄ν„°λ” Pylonμ΄ κ΄€λ¦¬
   - ν΄λΌμ΄μ–ΈνΈ(Desktop/Mobile)λ” Pylonμ—μ„ μ¤λ” μ΄λ²¤νΈλ¥Ό κ·Έλ€λ΅ ν‘μ‹
   - λ©”μ‹μ§€ μ „μ†΅ μ‹: ν΄λΌμ΄μ–ΈνΈκ°€ μ§μ ‘ UIμ— μ¶”κ°€ν•μ§€ μ•κ³ , Pylonμ `userMessage` μ΄λ²¤νΈλ¥Ό κΈ°λ‹¤λ¦Ό
   - μ΄μ : μ—¬λ¬ μ°½(Desktop 2κ° λ“±)μ—μ„ λ™μΌν• μƒνƒλ¥Ό λ³΄μ¥

4. **λ΅μ»¬ ν†µμ‹  λ¨λ“ (ν–¥ν›„)**
   - Relay μ¥μ•  μ‹ fallbackμΌλ΅ κ²€ν† 
   - Desktop β†’ Pylon (localhost:9000) μ§μ ‘ μ—°κ²°
   - ν„μ¬λ” λ―Έκµ¬ν„

---

## μ»΄ν¬λ„νΈ μƒμ„Έ

### 1. Relay (estelle-relay)

**μ—­ν• **: μ¤‘μ•™ λΌμ°ν… μ„λ²„

**μ²λ¦¬ν•λ” λ©”μ‹μ§€**:
- `auth` - μΈμ¦
- `get_devices` - μ—°κ²°λ λ””λ°”μ΄μ¤ λ©λ΅
- `ping` - μ—°κ²° ν™•μΈ

**λΌμ°ν… κ·μΉ™**:
- `to: { deviceId, deviceType }` β†’ ν•΄λ‹Ή λ””λ°”μ΄μ¤λ΅ μ§μ ‘ μ „μ†΅
- `broadcast: 'all'` β†’ λ¨λ“  μΈμ¦λ ν΄λΌμ΄μ–ΈνΈ
- `broadcast: 'pylons'` β†’ λ¨λ“  Pylon
- `broadcast: 'clients'` β†’ Pylon μ μ™Έ λ¨λ“  ν΄λΌμ΄μ–ΈνΈ
- κΈ°λ³Έ: Pylonμ΄ λ³΄λ‚΄λ©΄ β†’ ν΄λΌμ΄μ–ΈνΈλ“¤λ΅, ν΄λΌμ΄μ–ΈνΈκ°€ λ³΄λ‚΄λ©΄ β†’ Pylonλ“¤λ΅

### 2. Pylon (estelle-pylon)

**μ—­ν• **: PC λ°±κ·ΈλΌμ΄λ“ μ„λΉ„μ¤

**κΈ°λ¥**:
- Relay μ—°κ²° μ μ§€
- Claude SDK μ‹¤ν–‰ λ° κ΄€λ¦¬
- λ°μ¤ν¬ κ΄€λ¦¬

**λ©”μ‹μ§€ μ²λ¦¬**:
- Relayλ΅λ¶€ν„° λ°›μ€ λ©”μ‹μ§€ μ¤‘ μμ‹ μ—κ² μ¨ κ²ƒλ§ μ²λ¦¬
- `to.deviceId`κ°€ μμ‹ μ΄λ©΄ β†’ λ΅μ»¬ μ²λ¦¬

### 3. Client (estelle-app)

**μ—­ν• **: ν†µν•© ν΄λΌμ΄μ–ΈνΈ μ•± (Flutter)

**μ§€μ› ν”λ«νΌ**:
- Windows (Desktop)
- Android (Mobile)
- Web

**κΈ°μ  μ¤νƒ**:
- Flutter + Dart
- Riverpod (μƒνƒ κ΄€λ¦¬)
- web_socket_channel (WebSocket)

**μ—°κ²°**:
- Relayμ— μ§μ ‘ μ—°κ²° (`wss://estelle-relay.fly.dev`)
- λ™μ  deviceId μ‚¬μ© (100+)

**κΈ°λ¥**:
- λ¨λ“  Pylonμ λ°μ¤ν¬ λ©λ΅ ν‘μ‹ (μ§‘/νμ‚¬ λ“±)
- Claude λ©”μ‹μ§€ μ†΅μμ‹ 
- κ¶ν• μ”μ²­ μ‘λ‹µ
- λ°μ¤ν¬ μƒμ„±/μ‚­μ /μ΄λ¦„ λ³€κ²½

**λ°μ‘ν• UI**:
- Desktop (>=600px): μ‚¬μ΄λ“λ°”(260px) + μ±„ν… μμ—­
- Mobile (<600px): PageView μ¤μ™€μ΄ν”„ (λ°μ¤ν¬ λ©λ΅ β†” μ±„ν…)

---

## Device ID μ²΄κ³„

### μ •μ  ID (1-99)

| deviceId | μ΄λ¦„ | μ•„μ΄μ½ | μ—­ν•  |
|----------|------|--------|------|
| 1 | Selene | π™ | μ§‘ PC |
| 2 | Stella | β­ | νμ‚¬ PC |

### λ™μ  ID (100+)

Desktop, Mobile λ“± ν΄λΌμ΄μ–ΈνΈκ°€ μ ‘μ† μ‹ μλ™ ν• λ‹Ή:
```
deviceId = 100 + random(0-899)
```

---

## λ©”μ‹μ§€ ν•μ‹

### κΈ°λ³Έ κµ¬μ΅°

```json
{
  "type": "λ©”μ‹μ§€_νƒ€μ…",
  "to": { "deviceId": 1, "deviceType": "pylon" },  // μ„ νƒ
  "broadcast": "clients",  // μ„ νƒ
  "payload": { ... }
}
```

### μ£Όμ” λ©”μ‹μ§€ νƒ€μ…

| νƒ€μ… | λ°©ν–¥ | μ„¤λ… |
|------|------|------|
| `auth` | β†’ Relay | μΈμ¦ μ”μ²­ |
| `auth_result` | β† Relay | μΈμ¦ κ²°κ³Ό |
| `desk_list` | β†’ Pylon | λ°μ¤ν¬ λ©λ΅ μ”μ²­ |
| `desk_list_result` | β† Pylon | λ°μ¤ν¬ λ©λ΅ |
| `claude_send` | β†’ Pylon | Claude λ©”μ‹μ§€ μ „μ†΅ |
| `claude_event` | β† Pylon | Claude μ΄λ²¤νΈ (ν…μ¤νΈ, ν΄ λ“±) |
| `claude_permission` | β†’ Pylon | κ¶ν• μ‘λ‹µ |
| `claude_control` | β†’ Pylon | μ μ–΄ (stop, new_session) |

### λ°μ¤ν¬ λ©λ΅ μ΅°ν ν”λ΅μ°

```
1. Desktop/Mobile μΈμ¦ μ„±κ³µ μ‹:
   β†’ { type: 'desk_list', broadcast: 'pylons' }

2. Relayκ°€ λ¨λ“  Pylonμ— λΈλ΅λ“μΊμ¤νΈ:
   β†’ κ° Pylonμ—κ² { type: 'desk_list', from: { deviceId: 100, ... } }

3. κ° Pylonμ΄ μ‘λ‹µ:
   β†’ { type: 'desk_list_result', to: { deviceId: 100, deviceType: 'desktop' }, payload: { deviceId, deviceInfo, desks } }
   λλ” broadcast: 'clients'λ΅ λ¨λ“  ν΄λΌμ΄μ–ΈνΈμ— λΈλ΅λ“μΊμ¤νΈ

4. Desktop/Mobileμ΄ desk_list_result μμ‹ :
   β†’ deviceIdλ³„λ΅ Mapμ— μ €μ¥ν•μ—¬ μ—¬λ¬ Pylon λ°μ¤ν¬ ν‘μ‹
```

---

## λ΅κΉ… & λ””λ²„κΉ… μ‹μ¤ν…

### λ΅κΉ…

λ¨λ“  ν¨ν‚·μ„ JSON Lines ν•μ‹μΌλ΅ λ΅κΉ…:

```
estelle-pylon/logs/
  packets-2026-01-21T00-58-02.jsonl
  packets-2026-01-21T01-26-13.jsonl
```

λ΅κ·Έ νμΌ ν•μ‹ (ν• μ¤„ = ν•λ‚μ ν¨ν‚·):
```json
{"ts":"2026-01-21T14:30:00.123Z","dir":"recv","type":"claude_send","data":{...}}
{"ts":"2026-01-21T14:30:01.456Z","dir":"send","type":"claude_event","data":{...}}
```

### μ…λ ¥ μ‹λ®¬λ μ΄μ… (inbox)

μ‹¤ν–‰ μ¤‘μΈ μ•±μ—μ„ inbox ν΄λ”λ¥Ό κ°μ‹:
```
inbox/
  test_message.json  β†’ λ„£μΌλ©΄ μ¦‰μ‹ μ²λ¦¬λ¨
processed/
  test_message.json  β†’ μ²λ¦¬ ν›„ μ΄λ™
```

**μ¬ν„ ν”λ΅μ°**:
1. λ²„κ·Έ λ°μƒ
2. logs/ ν΄λ”μ—μ„ κ΄€λ ¨ ν¨ν‚· ν™•μΈ
3. inbox/μ— λ³µμ‚¬
4. μ¬ν„ μ™„λ£

---

## νμΌ κµ¬μ΅°

```
estelle/
β”β”€β”€ estelle-relay/       # Relay μ„λ²„ (Fly.io)
β”‚   β””β”€β”€ src/index.js
β”β”€β”€ estelle-pylon/       # PC λ°±κ·ΈλΌμ΄λ“ μ„λΉ„μ¤
β”‚   β””β”€β”€ src/
β”‚       β”β”€β”€ index.js
β”‚       β”β”€β”€ localServer.js
β”‚       β”β”€β”€ claudeManager.js
β”‚       β””β”€β”€ deskStore.js
β”β”€β”€ estelle-app/         # ν†µν•© ν΄λΌμ΄μ–ΈνΈ (Flutter)
β”‚   β””β”€β”€ lib/
β”‚       β”β”€β”€ main.dart
β”‚       β”β”€β”€ app.dart
β”‚       β”β”€β”€ core/           # μƒμ, ν…λ§, μ ν‹Έ
β”‚       β”β”€β”€ data/           # λ¨λΈ, μ„λΉ„μ¤
β”‚       β”β”€β”€ state/          # Riverpod providers
β”‚       β””β”€β”€ ui/             # λ μ΄μ•„μ›ƒ, μ„μ ―
β”β”€β”€ estelle-shared/      # κ³µμ  νƒ€μ…/μƒμ
β”‚   β”β”€β”€ index.js
β”‚   β””β”€β”€ index.d.ts
β”β”€β”€ docs/                # ν”„λ΅μ νΈ λ¬Έμ„
β”‚   β”β”€β”€ architecture.md
β”‚   β””β”€β”€ characters/      # μΊλ¦­ν„° μ„¤μ •
β”‚       β”β”€β”€ characters.md
β”‚       β””β”€β”€ persona-*.md
β”β”€β”€ wip/                 # μ§„ν–‰ μ¤‘μΈ μ‘μ—…
β”‚   β””β”€β”€ *.md
β””β”€β”€ log/                 # μ™„λ£λ μ‘μ—… λ΅κ·Έ
    β””β”€β”€ YYYY-MM-DD-*.md
```

---

*Last updated: 2026-01-23*
